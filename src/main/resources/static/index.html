<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoComet Gaming Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .rank-1 { background-color: #ffd700; font-weight: bold; } /* Gold */
        .rank-2 { background-color: #c0c0c0; font-weight: bold; } /* Silver */
        .rank-3 { background-color: #cd7f32; font-weight: bold; } /* Bronze */
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-5 text-primary">Live Gaming Leaderboard</h1>
        <p class="text-muted">High-Frequency Real-Time Updates</p>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Top 10 Players</h5>
                    <span class="badge bg-danger" id="live-indicator">LIVE</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Rank</th>
                                <th>User ID</th>
                                <th>Total Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="3" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Check Your Rank</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="userIdInput" class="form-label">Enter User ID</label>
                        <input type="number" class="form-control" id="userIdInput" placeholder="e.g. 891948">
                    </div>
                    <button class="btn btn-primary w-100" onclick="checkRank()">Search Rank</button>
                    
                    <div id="rankResult" class="mt-3 alert alert-info d-none">
                        <strong>User:</strong> <span id="resUser"></span><br>
                        <strong>Rank:</strong> <span id="resRank" class="fs-4 fw-bold"></span>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-body">
                    <h6>System Status</h6>
                    <small class="text-success">● Redis: Connected</small><br>
                    <small class="text-success">● Database: Online</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/leaderboard';

    // 1. Function to Fetch Top 10 (Runs every 2 seconds)
    async function updateLeaderboard() {
        try {
            const response = await fetch(`${API_BASE}/top`);
            const data = await response.json();
            
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = ''; // Clear old data

            data.forEach((entry, index) => {
                const rank = index + 1;
                // Handle the nested User object correctly
                const userId = entry.user ? entry.user.id : 'Unknown';
                const score = entry.totalScore;

                let rowClass = '';
                if (rank === 1) rowClass = 'rank-1';
                if (rank === 2) rowClass = 'rank-2';
                if (rank === 3) rowClass = 'rank-3';

                const row = `
                    <tr class="${rowClass}">
                        <td>#${rank}</td>
                        <td>User ${userId}</td>
                        <td>${score.toLocaleString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Blink the "LIVE" badge to show activity
            const badge = document.getElementById('live-indicator');
            badge.style.opacity = (badge.style.opacity === '0.5' ? '1' : '0.5');

        } catch (error) {
            console.error('Error fetching leaderboard:', error);
        }
    }

    // 2. Function to Check Specific User Rank
    async function checkRank() {
        const userId = document.getElementById('userIdInput').value;
        if (!userId) return alert("Please enter a User ID");

        const resultBox = document.getElementById('rankResult');
        resultBox.classList.remove('d-none');
        resultBox.className = 'mt-3 alert alert-secondary'; // Loading state
        document.getElementById('resUser').innerText = userId;
        document.getElementById('resRank').innerText = "Loading...";

        try {
            const response = await fetch(`${API_BASE}/rank/${userId}`);
            const data = await response.json();

            resultBox.className = 'mt-3 alert alert-success';
            document.getElementById('resRank').innerText = '#' + data.rank;
        } catch (error) {
            resultBox.className = 'mt-3 alert alert-danger';
            document.getElementById('resRank').innerText = "Not Found / Error";
        }
    }

    // Start the polling loop (Every 2000ms = 2 seconds)
    setInterval(updateLeaderboard, 2000);
    
    // Initial load
    updateLeaderboard();
</script>

</body>
</html>
